name: Google Classroom → Apple Reminders Sync

on:
  schedule:
    - cron: '30 6 * * *'   # 12:00 PM IST
    - cron: '5 11 * * *'    # 04:35 PM IST
    - cron: '30 12 * * *'  # 06:00 PM IST
    - cron: '30 16 * * *'  # 10:00 PM IST
  
  # Allow manual trigger
  workflow_dispatch:

# Prevent overlapping runs if GitHub delays jobs
concurrency:
  group: classroom-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: google-classroom-sync
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Verify environment variables
        run: |
          echo "Checking environment variables..."
          test -n "$SUPABASE_URL" && echo "✓ SUPABASE_URL set" || echo "✗ SUPABASE_URL missing"
          test -n "$SUPABASE_KEY" && echo "✓ SUPABASE_KEY set" || echo "✗ SUPABASE_KEY missing"
          test -n "$GOOGLE_CLIENT_ID" && echo "✓ GOOGLE_CLIENT_ID set" || echo "✗ GOOGLE_CLIENT_ID missing"
          test -n "$GOOGLE_CLIENT_SECRET" && echo "✓ GOOGLE_CLIENT_SECRET set" || echo "✗ GOOGLE_CLIENT_SECRET missing"
          test -n "$GOOGLE_REFRESH_TOKEN" && echo "✓ GOOGLE_REFRESH_TOKEN set" || echo "✗ GOOGLE_REFRESH_TOKEN missing"
          test -n "$APPLE_USERNAME" && echo "✓ APPLE_USERNAME set" || echo "✗ APPLE_USERNAME missing"
          test -n "$APPLE_PASSWORD" && echo "✓ APPLE_PASSWORD set" || echo "✗ APPLE_PASSWORD missing"
          test -n "$CALDAV_URL" && echo "✓ CALDAV_URL set" || echo "✗ CALDAV_URL missing"
          test -n "$RESEND_API_KEY" && echo "✓ RESEND_API_KEY set" || echo "✗ RESEND_API_KEY missing"
          test -n "$ALERT_EMAIL" && echo "✓ ALERT_EMAIL set" || echo "✗ ALERT_EMAIL missing"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          APPLE_USERNAME: ${{ secrets.APPLE_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          CALDAV_URL: ${{ secrets.CALDAV_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
      
      - name: Run sync
        env:
          # Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          
          # Google Classroom
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          
          # Apple Reminders
          APPLE_USERNAME: ${{ secrets.APPLE_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          CALDAV_URL: ${{ secrets.CALDAV_URL }}
          
          # Email Alerts
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          
          # Timezone
          TIMEZONE: Asia/Kolkata
          
          # Notification Window
          NOTIFICATION_START_HOUR: 7
          NOTIFICATION_END_HOUR: 24
          
          # GitHub Actions context for error reporting
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          cd backend
          python main.py
